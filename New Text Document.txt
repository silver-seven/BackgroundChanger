using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Drawing;
using System.Runtime.InteropServices;
using Microsoft.Win32;
using System.IO;
using System.Threading;
using System.Windows.Forms;
namespace BackgroundChangerForm
{
    public partial class Form1
    {

        public static LinkedList<String> files = new LinkedList<String>();
        public static Queue<String> files_exc = new Queue<String>();
        private static Random randNum = new Random();
        public static String pathDir;
        public static int countdown;
        public static String excludeFileName;
        public static String configFileName;
        public static int bufferSize;

        public static void get_images(string dir)
        {
            try
            {
                foreach (string f in Directory.GetFiles(dir))
                {
                    files.AddLast(Path.GetFileName(f));
                }
            }
            catch
            {

            }
        }

        public static void get_image_exclusions(string f)
        {
            StreamWriter file = new StreamWriter(f);
            file.Close();
            foreach (string line in File.ReadLines(f))
            {
                files_exc.Enqueue(line);
            }
        }

        public static void remove_excluded_images()
        {

            int loopCount = files.Count;
            foreach (string ex in files_exc)
            {
                files.Remove(ex);
            }
        }

        public static int get_random_num(int min, int max)
        {
            lock (randNum)
            {
                return randNum.Next(min, max);
            }
        }

        public static void add_to_exclusions(string img)
        {
            if (files_exc.Count >= bufferSize)
            {
                files_exc.Enqueue(img);
                files.AddLast(files_exc.Dequeue());

            }
            else
            {
                files_exc.Enqueue(img);
            }
        }

        public static void write_list_to_file(string file)
        {
            StreamWriter f = new StreamWriter(file);
            foreach (string ex in files_exc)
            {
                f.WriteLine(ex);
            }
            f.Close();
        }


        public enum PicStyle
        {
            Tile, Center, Stretch, Fit, Fill
        }

        internal sealed class NativeMethods
        {
            [DllImport("user32.dll", CharSet = CharSet.Auto)]
            internal static extern int SystemParametersInfo(
                int uAction,
                int uParam,
                String lpvParam,
                int fuWinIni
                );
        }

        public static void set_background(string path, PicStyle style)
        {
            Console.WriteLine("Setting " + Path.GetFileName(path) + " as background...");
            RegistryKey key = Registry.CurrentUser.OpenSubKey(@"Control Panel\Desktop", true);
            switch (style)
            {
                case PicStyle.Tile:
                    key.SetValue(@"PicStyle", "0");
                    key.SetValue(@"TileWallpaper", "1");
                    break;
                case PicStyle.Center:
                    key.SetValue(@"PicStyle", "0");
                    key.SetValue(@"TileWallpaper", "0");
                    break;
                case PicStyle.Stretch:
                    key.SetValue(@"PicStyle", "2");
                    key.SetValue(@"TileWallpaper", "0");
                    break;
                case PicStyle.Fit:
                    key.SetValue(@"PicStyle", "6");
                    key.SetValue(@"TileWallpaper", "0");
                    break;
                case PicStyle.Fill:
                    key.SetValue(@"PicStyle", "10");
                    key.SetValue(@"TileWallpaper", "0");
                    break;
            }
            key.Close();

            const int SET_DESKTOP_BACKGROUND = 20;
            const int UPDATE_INI_FILE = 1;
            const int SEND_WINDOWS_INI_CHANGE = 2;
            NativeMethods.SystemParametersInfo(SET_DESKTOP_BACKGROUND, 0, path, UPDATE_INI_FILE | SEND_WINDOWS_INI_CHANGE);
        }

        private void InitializeComponent()
        {
            this.SuspendLayout();
            // 
            // Form1
            // 
            this.ClientSize = new System.Drawing.Size(284, 261);
            this.Name = "Form1";
            this.ResumeLayout(false);

        }
    }
}
